<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Isaac & Reya's Wedding</title>
</head>
<body>
  <h1>Isaac & Reya's Wedding</h1>
  <p>Search your name to RSVP for you and your family.</p>

  <input type="text" id="searchInput" placeholder="Enter your name" />
  <div id="searchResults"></div>

  <h3>Family RSVP</h3>
  <div id="familyRSVP"></div>
  <button id="submitBtn" style="display:none;">Submit RSVP</button>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbx1WpW_D2O5-pnKWtW6yQgwRANOwfHB-rrARfsFP7yciijTwJlVEbkfpAHIMR5GDGiwQQ/exec";

    let selectedFamilyId = null;
    let familyResponses = {};

    // --- Search guests ---
    document.getElementById("searchInput").addEventListener("input", async function() {
      const searchTerm = this.value.toLowerCase();
      if (searchTerm.length < 2) return;

      try {
        const response = await fetch(`${apiUrl}?action=getGuestList`, {
          method: "GET",
        });
        const guests = await response.json();

        // guests is a 2D array from Google Sheets
        const matches = guests.filter(row =>
          row[0] && row[0].toLowerCase().includes(searchTerm)
        );

        let resultsDiv = document.getElementById("searchResults");
        resultsDiv.innerHTML = "";
        matches.forEach(row => {
          let div = document.createElement("div");
          div.textContent = row[0];
          div.style.cursor = "pointer";
          div.onclick = () => selectGuest(row[1], guests); // pass familyId + full list
          resultsDiv.appendChild(div);
        });
      } catch (err) {
        console.error("Error fetching guest list:", err);
      }
    });

    // --- Select a guest and show family RSVP ---
    function selectGuest(familyId, allGuests) {
      selectedFamilyId = familyId;
      const family = allGuests.filter(row => row[1] === familyId);

      let familyDiv = document.getElementById("familyRSVP");
      familyDiv.innerHTML = "";
      familyResponses = {};

      family.forEach(member => {
        const guestName = member[0];
        const currentRSVP = member[2] === "Yes";

        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = currentRSVP;
        checkbox.onchange = () => {
          familyResponses[guestName] = checkbox.checked ? "Yes" : "No";
        };
        familyResponses[guestName] = currentRSVP ? "Yes" : "No";

        let label = document.createElement("label");
        label.textContent = guestName + " ";

        let div = document.createElement("div");
        div.appendChild(label);
        div.appendChild(checkbox);
        div.append(" Attending");

        familyDiv.appendChild(div);
      });

      document.getElementById("submitBtn").style.display = "block";
    }

    // --- Submit RSVP ---
    document.getElementById("submitBtn").addEventListener("click", async () => {
      if (!selectedFamilyId) return alert("Please select your name first.");

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            familyId: selectedFamilyId,
            responses: familyResponses
          }),
        });

        const result = await response.json();
        alert(result.message || "RSVP saved!");
      } catch (err) {
        console.error("Error saving RSVP:", err);
        alert("There was an error saving your RSVP.");
      }
    });
  </script>
</body>
</html>
